<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmonix - Multiplayer</title>
    
    <script>
        window.addEventListener('error', function(e) { console.error("System Error:", e.message); });
        window.createRoom = function() { alert("⏳ ระบบกำลังเตรียมพร้อม..."); };
        window.joinRoom = function() { alert("⏳ ระบบกำลังเตรียมพร้อม..."); };
        window.showJoin = function() { alert("⏳ ระบบกำลังเตรียมพร้อม..."); };
    </script>

    <script src="https://unpkg.com/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS Theme --- */
        :root { 
            --bg-app: #0F172A; --surface: #1E293B; --active-note: #FACC15; --voice-highlight: #38BDF8; --text-main: #F1F5F9; 
            --success: #10B981; --accent: #C084FC; --border-color: #334155;
            --shadow-dark: #020617; --shadow-success: #047857; --shadow-blue: #0369a1; --shadow-yellow: #b45309; --shadow-red: #b91c1c;
        }
        body { font-family: 'Sarabun'; background: var(--bg-app); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); }
        .hidden { display: none !important; }

        @keyframes flashGlow { 0% { box-shadow: inset 0 0 0 0 transparent; } 50% { box-shadow: inset 0 0 60px 20px rgba(239, 68, 68, 0.6); } 100% { box-shadow: inset 0 0 0 0 transparent; } }
        .urgent-mode { animation: flashGlow 1s infinite ease-in-out; }

        /* Lobby UI */
        .lobby-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .pin-container { background: rgba(0,0,0,0.3); padding: 10px 25px; border-radius: 16px; border: 2px solid var(--active-note); margin-bottom: 20px; display: inline-block; box-shadow: 0 0 20px rgba(250, 204, 21, 0.1); }
        .pin-label { color: #94A3B8; font-size: 0.8rem; font-weight: bold; letter-spacing: 2px; }
        .pin-box { font-size: 3rem; font-weight: 900; color: var(--active-note); letter-spacing: 6px; line-height: 1; }
        
        .p-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; width: 100%; max-width: 600px; margin-bottom: 30px; min-height: 50px; }
        .p-badge { display: inline-flex; align-items: center; gap: 8px; background: #334155; padding: 6px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        
        .btn-big { background: var(--voice-highlight); color: #0F172A; padding: 15px 40px; font-size: 1.2rem; border-radius: 15px; font-weight: 800; border: none; cursor: pointer; width: 100%; max-width: 250px; margin: 8px; transition: 0.1s; box-shadow: 0 6px 0 var(--shadow-blue); text-decoration: none; display: inline-flex; justify-content: center; }
        .btn-big:active { transform: translateY(6px); box-shadow: none; }
        .btn-big.btn-outline { background: #1e293b; border: 2px solid #334155; color: #94A3B8; box-shadow: 0 6px 0 #0f172a; }
        .btn-big.btn-outline:active { transform: translateY(6px); box-shadow: none; }
        .input-pin { background: var(--surface); border: 2px solid #334155; color: white; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 15px; width: 200px; margin-bottom: 20px; font-weight: bold; }

        /* Game UI */
        #top-area { flex-shrink: 0; background: var(--surface); z-index: 20; border-bottom: 1px solid var(--border-color); }
        #timer-bar-fill { width: 100%; height: 6px; background: #34D399; transition: width 0.1s linear; }
        #nav-bar { height: 60px; padding: 0 15px; display: grid; grid-template-columns: 80px 1fr auto; align-items: center; }
        .back-btn { text-decoration: none; font-weight: 700; color: #94A3B8; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; justify-self: start; padding: 8px; border-radius: 8px; }
        .back-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .stats-center { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .score-val { font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--active-note); font-weight: 800; text-shadow: 0 0 10px rgba(250,204,21,0.3); }
        .diff-tag { font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; background: #334155; color: #94A3B8; text-transform: uppercase; }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); width: 36px; height: 36px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .user-profile { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px 12px 4px 4px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .u-avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--active-note); }

        #score-area { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; background: radial-gradient(circle at center, #263346 0%, #0F172A 100%); }
        #vexflow-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #vexflow-out { width: 100%; display:flex; justify-content:center; filter: invert(100%) opacity(0.9) drop-shadow(0 0 2px rgba(255,255,255,0.2)); }

        #control-panel { flex-shrink: 0; background: #162032; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; padding-bottom: max(15px, env(safe-area-inset-bottom)); z-index: 50; }
        .info-bar { padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .target-val { font-size: 1.1rem; font-weight: 800; color: #38BDF8; font-family: 'Noto Serif', serif; }
        .submit-btn { background: var(--success); color: #064E3B; border: none; padding: 0 20px; height: 36px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: 0.1s; box-shadow: 0 4px 0 var(--shadow-success); }
        .submit-btn:active { transform: translateY(4px); box-shadow: none; }
        .controls-grid { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .voice-row { display: flex; gap: 6px; width: 100%; }
        .btn-v { flex: 1; background: #334155; border: none; padding: 8px 0; border-radius: 8px; color: #94A3B8; font-weight: 800; font-size: 0.8rem; cursor: pointer; transition: 0.1s; text-transform: uppercase; box-shadow: 0 3px 0 var(--shadow-dark); }
        .btn-v:active { transform: translateY(3px); box-shadow: none; }
        .btn-v.selected { background: var(--active-note); color: #0F172A; box-shadow: 0 3px 0 var(--shadow-yellow); transform: translateY(0); }
        .btn-v.locked { opacity: 0.3; pointer-events: none; background: #1E293B; box-shadow: none; }
        .note-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .btn-n { background: #1e293b; border: 1px solid #334155; padding: 0; border-radius: 10px; color: white; font-size: 1.2rem; font-weight: 800; cursor: pointer; height: 45px; transition: 0.1s; box-shadow: 0 4px 0 var(--shadow-dark); }
        .btn-n:active { transform: translateY(4px); box-shadow: none; }
        .btn-n.active { background: var(--accent); color: white; border: none; box-shadow: 0 4px 0 var(--shadow-purple); }
        .tool-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
        .btn-tool { background: #334155; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; height: 38px; font-size: 0.9rem; transition: 0.1s; box-shadow: 0 3px 0 var(--shadow-dark); }
        .btn-tool:active { transform: translateY(3px); box-shadow: none; }
        .btn-undo { background: #EF4444; box-shadow: 0 3px 0 #991b1b; }

        /* Settings UI */
        .diff-btn { width: 30%; padding: 10px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; color: #0F172A; margin: 0 5px; opacity: 0.6; transition: 0.1s; box-shadow: 0 4px 0 var(--shadow-dark); }
        .diff-btn.active { opacity: 1; transform: translateY(0); }
        .btn-green { background: #34D399; box-shadow: 0 4px 0 #047857; }
        .btn-yellow { background: #FACC15; box-shadow: 0 4px 0 #ca8a04; }
        .btn-red { background: #F43F5E; box-shadow: 0 4px 0 #be123c; }
        .setting-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: left; }
        .setting-label { font-size: 0.9rem; color: #94A3B8; margin-bottom: 5px; display: block; font-weight: bold; }
        .custom-select { width: 100%; padding: 10px; border-radius: 8px; background: #1E293B; color: white; border: 1px solid #334155; font-size: 1rem; font-weight: bold; }

        /* Overlays */
        #summary-overlay, #friends-overlay, #player-overlay { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); padding: 20px; }
        #waiting-overlay { position: absolute; inset: 0; background: rgba(15,23,42,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 110; backdrop-filter: blur(5px); }
        
        /* สไตล์หน้าเฉลยใหม่ */
        #summary-vex-container { 
            width: 100%; 
            max-width: 400px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 15px; 
            margin-bottom: 20px;
            padding: 10px;
            filter: invert(100%) opacity(0.9) drop-shadow(0 0 2px rgba(255,255,255,0.2));
        }

        .bar-chart { display: flex; gap: 40px; align-items: flex-end; height: 120px; margin-bottom: 30px; }
        .bar { width: 60px; background: #334155; border-radius: 8px 8px 0 0; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; transition: height 0.5s; position: relative; }
        .bar-val { font-weight: bold; margin-bottom: 5px; color: white; font-size:1.2rem; }
        .bar-label { position: absolute; bottom: -30px; font-size: 1rem; color: #94A3B8; font-weight: bold; }
        .bar.correct { background: #34D399; box-shadow: 0 0 15px rgba(52, 211, 153, 0.4); }
        .bar.wrong { background: #F43F5E; box-shadow: 0 0 15px rgba(244, 63, 94, 0.4); }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--active-note); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; margin-bottom: 15px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Rankings */
        .rank-row { display: flex; justify-content: space-between; align-items: center; width: 100%; background: #334155; padding: 10px 15px; border-radius: 12px; margin-bottom: 5px; box-sizing: border-box; cursor: pointer; transition: 0.1s; }
        .rank-row:active { transform: scale(0.98); background: #475569; }
        .podium-box { display: flex; align-items: flex-end; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .pod-step { width: 80px; border-radius: 10px 10px 0 0; display: flex; flex-direction: column; align-items: center; padding: 10px; color: #0F172A; font-weight: bold; text-align: center; }
        .pod-1 { height: 180px; background: #FACC15; z-index: 2; box-shadow: 0 0 20px rgba(250,204,21,0.5); }
        .pod-2 { height: 140px; background: #94A3B8; }
        .pod-3 { height: 100px; background: #B45309; color: #FFFBEB; }
        .pod-avatar { width: 50px; height: 50px; border-radius: 50%; border: 3px solid white; margin-bottom: 5px; background:#000; }
    </style>
</head>
<body>

    <div id="join-screen" class="lobby-box hidden">
        <h2 style="color:white;">ใส่รหัสห้อง</h2>
        <input type="number" id="room-pin" class="input-pin" placeholder="123456">
        <button id="btn-join-action" class="btn-big" onclick="playSfx('click'); joinRoom()">เข้าห้อง</button>
        <a href="online_hub.html" class="btn-big btn-outline" style="text-decoration:none; line-height:50px; box-sizing:border-box;">ยกเลิก</a>
    </div>

    <div id="lobby-screen" class="lobby-box hidden">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:flex-start; padding:0 10px;">
            <div style="text-align:left;">
                <div class="pin-container">
                    <div class="pin-label">ROOM PIN</div>
                    <div class="pin-box" id="pin-disp">...</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="icon-btn" onclick="playSfx('click'); openFriends()"><i class="fa-solid fa-user-plus"></i></div>
            </div>
        </div>
        
        <div style="margin:10px 0 20px; font-weight:bold; color:#94A3B8; font-size:0.9rem;">ผู้เล่นในห้อง (รอเพื่อน...)</div>
        <div class="p-list" id="player-list"></div>
        
        <div id="host-controls" class="hidden" style="width:100%; max-width:400px;">
            <div class="setting-box">
                <label class="setting-label"><i class="fa-solid fa-layer-group"></i> ความยาก</label>
                <div style="display:flex; justify-content:center;">
                    <button id="btn-easy" class="diff-btn btn-green active" onclick="playSfx('click'); setDiff('easy')">Easy</button>
                    <button id="btn-norm" class="diff-btn btn-yellow" onclick="playSfx('click'); setDiff('medium')">Normal</button>
                    <button id="btn-hard" class="diff-btn btn-red" onclick="playSfx('click'); setDiff('hard')">Hard</button>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="setting-box" style="flex:1;">
                    <label class="setting-label"><i class="fa-solid fa-clock"></i> เวลาต่อข้อ</label>
                    <select id="sel-time" class="custom-select" onchange="updateSettings()">
                        <option value="10">10 วินาที</option>
                        <option value="15">15 วินาที</option>
                        <option value="20">20 วินาที</option>
                        <option value="25">25 วินาที</option>
                        <option value="30" selected>30 วินาที</option>
                    </select>
                </div>
                <div class="setting-box" style="flex:1;">
                    <label class="setting-label"><i class="fa-solid fa-list-ol"></i> จำนวนข้อ</label>
                    <select id="sel-round" class="custom-select" onchange="updateSettings()">
                        <option value="5">5 ข้อ</option>
                        <option value="10" selected>10 ข้อ</option>
                        <option value="15">15 ข้อ</option>
                        <option value="20">20 ข้อ</option>
                    </select>
                </div>
            </div>
            <button class="btn-big" style="background:#38BDF8; color:#0F172A;" onclick="playSfx('start'); startGameHost()">เริ่มเกม!</button>
        </div>
        <div id="client-wait" class="hidden">รอหัวหน้าห้องเริ่มเกม...</div>
    </div>

    <div id="game-ui" class="hidden" style="height:100%; display:flex; flex-direction:column; position:relative;">
        <div id="waiting-overlay" class="hidden">
            <span class="loader"></span>
            <h2 style="color:#FACC15; margin:0;">รอเพื่อน...</h2>
            <p style="color:#94A3B8;">คำตอบถูกส่งแล้ว</p>
        </div>

        <div id="summary-overlay" class="hidden">
            <h1 id="sum-title" style="color:white;">หมดเวลา!</h1>
            <p style="color:#94A3B8;">เฉลย: <span id="ans-reveal" style="color:#38BDF8; font-weight:bold;">-</span></p>
            <div id="summary-vex-container"><div id="summary-vex-out"></div></div>
            <div class="bar-chart">
                <div class="bar correct" id="bar-correct"><div class="bar-val" id="val-correct">0</div><div class="bar-label">ถูก</div></div>
                <div class="bar wrong" id="bar-wrong"><div class="bar-val" id="val-wrong">0</div><div class="bar-label">ผิด</div></div>
            </div>
            <div id="host-next-btn" class="hidden">
                <button class="btn-big" onclick="nextQuestionHost()">ข้อถัดไป <i class="fa-solid fa-arrow-right"></i></button>
            </div>
            <div id="client-wait-next" class="hidden">รอหัวหน้าห้อง...</div>
        </div>

        <div id="top-area">
            <div id="timer-bar-fill"></div>
            <div id="nav-bar">
                <a href="online_hub.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> ออก</a>
                <div class="stats-center">
                    <div id="score-disp" class="score-val">0</div>
                    <div id="diff-disp" class="diff-tag">EASY</div>
                </div>
                <div class="header-actions">
                    <div class="user-profile">
                        <span id="u-name" style="font-size:0.8rem; font-weight:bold;">Player</span>
                        <img src="" class="u-avatar" id="u-img">
                    </div>
                </div>
            </div>
        </div>

        <div id="score-area"><div id="vexflow-wrapper"><div id="vexflow-out"></div></div></div>

        <div id="control-panel">
            <div class="info-bar">
                <div><div style="font-size:0.65rem; color:#94A3B8;">TARGET</div><div class="target-val" id="target-desc">-</div></div>
                <button class="submit-btn" onclick="submitAnswer()">ส่งคำตอบ <i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <div class="controls-grid">
                <div class="voice-row"><button class="btn-v" id="v-s">Soprano</button><button class="btn-v" id="v-a">Alto</button><button class="btn-v" id="v-t">Tenor</button><button class="btn-v" id="v-b">Bass</button></div>
                <div class="note-row"><button class="btn-n" onclick="playToneNote('c'); setNote('c')" id="n-c">C</button><button class="btn-n" onclick="playToneNote('d'); setNote('d')" id="n-d">D</button><button class="btn-n" onclick="playToneNote('e'); setNote('e')" id="n-e">E</button><button class="btn-n" onclick="playToneNote('f'); setNote('f')" id="n-f">F</button><button class="btn-n" onclick="playToneNote('g'); setNote('g')" id="n-g">G</button><button class="btn-n" onclick="playToneNote('a'); setNote('a')" id="n-a">A</button><button class="btn-n" onclick="playToneNote('b'); setNote('b')" id="n-b">B</button></div>
                <div class="tool-row">
                    <button class="btn-tool" onclick="setAcc('#')" style="color:#FACC15">♯</button><button class="btn-tool" onclick="setAcc('n')">♮</button><button class="btn-tool" onclick="setAcc('b')" style="color:#C084FC">♭</button>
                    <button class="btn-tool" onclick="shiftOctave(1)">Oct+</button><button class="btn-tool" onclick="shiftOctave(-1)">Oct-</button><button class="btn-tool btn-undo" onclick="undo()"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="rank-screen" class="lobby-box hidden">
        <h1 style="color:#FACC15;">PODIUM</h1>
        <div id="podium-display" class="podium-box"></div>
        <div id="final-list" style="width:100%; max-width:400px;"></div>
        <button class="btn-big" onclick="location.reload()">เล่นอีกครั้ง</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAj0BepQS_4kLTWmCF8rSzqW44XkgefEG8", authDomain: "harmonix-5c90e.firebaseapp.com", projectId: "harmonix-5c90e", storageBucket: "harmonix-5c90e.firebasestorage.app", messagingSenderId: "659742972654", appId: "1:659742972654:web:f8d532a857da37519db1ff" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- STATE ---
    let user=null, roomId=null, isHost=false, score=0;
    let isGameRunning = false;
    let gameSettings = { time: 30, rounds: 10 };
    let curV='s', missingVoice='s', currentKey='C';
    let targetSolution = null;
    let scoreData = [];
    let hasAnswered = false;
    let timerInterval = null;

    // --- AUTH ---
    auth.onAuthStateChanged(u => {
        if(u) {
            user = u;
            document.getElementById('u-name').innerText = u.displayName || "Player";
            document.getElementById('u-img').src = u.photoURL || "";
        } else { window.location.href='index.html'; }
    });

    // --- GAME BANK (Partial for Demo) ---
    const QUEST_BANK = [
        { k:'C', n:'C Major (I)', m:'s', s:{n:'c',o:5}, a:{n:'g',o:4}, t:{n:'e',o:4}, b:{n:'c',o:4}, diff:'easy' },
        { k:'C', n:'F Major (IV)', m:'a', s:{n:'c',o:5}, a:{n:'a',o:4}, t:{n:'f',o:4}, b:{n:'f',o:3}, diff:'easy' },
        { k:'G', n:'G Major (I)', m:'s', s:{n:'g',o:4}, a:{n:'d',o:4}, t:{n:'b',o:3}, b:{n:'g',o:3}, diff:'easy' }
    ];

    // --- CORE LOGIC ---
    window.createRoom = async () => {
        roomId = Math.floor(100000+Math.random()*900000).toString();
        isHost = true;
        await setDoc(doc(db,"rooms",roomId), { 
            host:user.uid, status:'waiting', difficulty:'easy', qIndex:0, players:{[user.uid]:{name:user.displayName, avatar:user.photoURL, score:0}}, settings:gameSettings 
        });
        setupRoomListener();
    };

    window.joinRoom = async () => {
        roomId = document.getElementById('room-pin').value;
        const ref = doc(db,"rooms",roomId);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            isHost = false;
            await updateDoc(ref, { [`players.${user.uid}`]: {name:user.displayName, avatar:user.photoURL, score:0} });
            setupRoomListener();
        }
    };

    function setupRoomListener() {
        document.getElementById('join-screen').classList.add('hidden');
        document.getElementById('lobby-screen').classList.remove('hidden');
        document.getElementById('pin-disp').innerText = roomId;
        if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        else document.getElementById('client-wait').classList.remove('hidden');

        onSnapshot(doc(db,"rooms",roomId), (snap) => {
            const data = snap.data();
            if(!data) return;
            gameSettings = data.settings || { time: 30, rounds: 10 };

            // Start Game
            if(data.status === 'playing') {
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                document.getElementById('summary-overlay').classList.add('hidden');
                
                // BUG FIX: ป้องกันการโหลดซ้ำถ้า qIndex เดิม
                if(window.lastQIndex !== data.qIndex) {
                    window.lastQIndex = data.qIndex;
                    hasAnswered = false;
                    document.getElementById('waiting-overlay').classList.add('hidden');
                    loadPuzzle(data.qIndex);
                    startTimer(data.endTime);
                }
            } else if (data.status === 'summary') {
                showSummary(data.roundResults, data.qIndex);
            }
        });
    }

    // --- TIMER SYSTEM (BUG FIXED) ---
    function startTimer(endTime) {
        if(timerInterval) clearInterval(timerInterval);
        const totalTime = (gameSettings.time || 30) * 1000;
        
        timerInterval = setInterval(() => {
            const now = Date.now();
            const timeLeft = endTime - now;
            const progress = (timeLeft / totalTime) * 100;

            const bar = document.getElementById('timer-bar-fill');
            if(bar) bar.style.width = `${Math.max(0, progress)}%`;

            if(timeLeft <= 5000) document.body.classList.add('urgent-mode');
            else document.body.classList.remove('urgent-mode');

            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                if(isHost) updateDoc(doc(db,"rooms",roomId), { status: 'summary' });
            }
        }, 100);
    }

    function loadPuzzle(idx) {
        const q = QUEST_BANK[idx] || QUEST_BANK[0];
        currentKey = q.k; missingVoice = q.m; curV = q.m;
        targetSolution = { s:q.s, a:q.a, t:q.t, b:q.b };
        scoreData = [{ key:q.k, beats:[{s:{...q.s}, a:{...q.a}, t:{...q.t}, b:{...q.b}, fig:q.fig}] }];
        
        // Clear input for missing part
        scoreData[0].beats[0][missingVoice] = { n:'c', o:4, acc:'' }; 
        
        document.getElementById('target-desc').innerText = q.n;
        renderScore(document.getElementById("vexflow-out"), scoreData[0], currentKey, missingVoice, true);
    }

    window.submitAnswer = async () => {
        if(hasAnswered) return;
        hasAnswered = true;
        document.getElementById('waiting-overlay').classList.remove('hidden');
        // Logic ตรวจคำตอบ (ข้ามเพื่อความกระชับ)
        await updateDoc(doc(db,"rooms",roomId), { [`roundResults.${user.uid}`]: true });
    };

    function showSummary(results, qIdx) {
        if(timerInterval) clearInterval(timerInterval);
        document.getElementById('summary-overlay').classList.remove('hidden');
        const q = QUEST_BANK[qIdx];
        document.getElementById('ans-reveal').innerText = q.n;
        renderScore(document.getElementById("summary-vex-out"), {key:q.k, beats:[q]}, q.k, q.m, false, true);
        
        if(isHost) document.getElementById('host-next-btn').classList.remove('hidden');
    }

    // --- VEXFLOW RENDERER ---
    function renderScore(targetDiv, data, key, highlightVoice, isGame, isSolution=false) {
        const VF = Vex.Flow;
        targetDiv.innerHTML = "";
        const width = targetDiv.clientWidth || 300;
        const renderer = new VF.Renderer(targetDiv, VF.Renderer.Backends.SVG);
        renderer.resize(width, isSolution ? 200 : 250);
        const ctx = renderer.getContext();
        const scale = isSolution ? 0.85 : 1.0;
        ctx.scale(scale, scale);
        
        // ฟังก์ชันวาดโน้ต (ใช้ตัวที่คุณชอบ)
        const staveT = new VF.Stave(10, 10, width/scale-20).addClef("treble").addKeySignature(key).setContext(ctx).draw();
        const staveB = new VF.Stave(10, 110, width/scale-20).addClef("bass").addKeySignature(key).setContext(ctx).draw();
        // ... (โค้ดวาดโน้ตเหมือนเดิม)
    }

    // --- HOST ACTIONS ---
    window.startGameHost = async () => {
        const endTime = Date.now() + (gameSettings.time * 1000);
        await updateDoc(doc(db,"rooms",roomId), { status:'playing', qIndex:0, endTime: endTime, roundResults:{} });
    };

    window.nextQuestionHost = async () => {
        const nextIdx = (window.lastQIndex + 1) % QUEST_BANK.length;
        const endTime = Date.now() + (gameSettings.time * 1000);
        await updateDoc(doc(db,"rooms",roomId), { status:'playing', qIndex: nextIdx, endTime: endTime, roundResults:{} });
    };

    // Global Setup
    window.setNote = (n) => { scoreData[0].beats[0][curV].n = n; renderScore(document.getElementById("vexflow-out"), scoreData[0], currentKey, missingVoice, true); };
    window.playSfx = (t) => console.log("SFX:", t);
</script>
</body>
</html>
