<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harmonix - Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) */
        :root { 
            --bg-app: #0F172A; --surface: #1E293B; --active-note: #FACC15; --voice-highlight: #38BDF8; --text-main: #F1F5F9; 
            --border-color: #334155; --btn-bg: #334155; --error: #F43F5E; --success: #34D399;
            --shadow-dark: #020617; --shadow-purple: #7e22ce; --shadow-red: #b91c1c; --shadow-blue: #0369a1;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-app); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text-main); }

        /* Top Bar */
        #top-bar { flex-shrink: 0; height: 50px; padding: 0 15px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; background: var(--surface); border-bottom: 1px solid var(--border-color); z-index: 20; }
        .back-btn { text-decoration: none; font-weight: 700; color: #94A3B8; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; justify-self: start; transition: 0.2s; }
        .back-btn:active { transform: scale(0.95); color: white; }
        .logo { font-weight: 800; color: #38BDF8; letter-spacing: 1px; font-size: 1.1rem; justify-self: center; }
        .key-wrapper { justify-self: end; }
        #key-select { appearance: none; background-color: #1e293b; color: var(--active-note); padding: 5px 12px; border-radius: 8px; border: 1px solid #334155; font-family: 'Sarabun'; font-weight: 700; font-size: 0.85rem; cursor: pointer; text-align: center; outline: none; transition: 0.1s; box-shadow: 0 3px 0 #0f172a; }
        #key-select:active { transform: translateY(3px); box-shadow: 0 0 0 #0f172a; }

        /* Score Area */
        #score-area { flex: 1; position: relative; display: flex; align-items: center; overflow: hidden; background: radial-gradient(circle at center, #263346 0%, #0F172A 100%); box-shadow: inset 0 0 50px rgba(0,0,0,0.6); min-height: 0; }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor: grab ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ */
        #vexflow-wrapper { flex: 1; overflow-x: auto; overflow-y: hidden; display: flex; align-items: center; padding: 0 10px; white-space: nowrap; scrollbar-width: none; height: 100%; cursor: grab; }
        #vexflow-wrapper.active { cursor: grabbing; } /* ‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏Å‡∏≥ */
        #vexflow-wrapper::-webkit-scrollbar { display: none; }
        #vexflow-out { min-width: 1800px; filter: invert(100%) opacity(0.9) drop-shadow(0 0 2px rgba(255,255,255,0.2)); display: inline-block; width: fit-content; }

        /* Warning Bar */
        #warning-bar { width: 100%; flex-shrink: 0; background: #162032; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 8px 15px; font-size: 0.9rem; font-weight: bold; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; color: var(--text-main); }
        .status-ok { color: var(--success); text-align: right; }
        .status-err { color: var(--error); text-align: right; animation: pulse 1s infinite; }
        .chord-info { display: flex; gap: 10px; color: var(--active-note); align-items: center; }
        .cadence-badge { background: #334155; color: #38BDF8; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; text-transform: uppercase; }

        /* Controls */
        #controls { flex-shrink: 0; background: var(--surface); border-top: 1px solid var(--border-color); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 15px 10px 20px 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); height: auto; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        /* Beat Scroll: ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor grab ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏° */
        .beat-scroll { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; flex-shrink: 0; cursor: grab; user-select: none; }
        .beat-scroll.active { cursor: grabbing; }
        
        .beat-box { min-width: 45px; height: 45px; background: #0F172A; border: 2px solid var(--border-color); border-radius: 12px; color: #64748B; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: 0.1s; box-shadow: 0 3px 0 #020617; }
        .beat-box:active { transform: translateY(3px); box-shadow: none; }
        .beat-box span { font-size: 0.6rem; text-transform: uppercase; }
        .beat-box.active { border-color: #38BDF8; color: #38BDF8; background: rgba(56, 189, 248, 0.1); box-shadow: 0 3px 0 #0ea5e9; transform: translateY(0); }
        .beat-box.active:active { transform: translateY(3px); box-shadow: none; }
        .beat-box.error { border-color: var(--error); background: rgba(244, 63, 94, 0.1); color: var(--error); box-shadow: 0 3px 0 #be123c; }

        .grid-main { display: grid; grid-template-columns: 60px 1fr; gap: 10px; }
        .voice-col { display: flex; flex-direction: column; gap: 6px; }
        .btn-v { flex: 1; background: #334155; border: none; border-radius: 8px; color: #94A3B8; font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.1s; padding: 0; box-shadow: 0 3px 0 #0f172a; position: relative; }
        .btn-v:active { transform: translateY(3px); box-shadow: none; }
        .btn-v.selected { background: var(--active-note); color: #0F172A; box-shadow: 0 3px 0 #b45309; transform: translateY(0); }
        .btn-v.selected:active { transform: translateY(3px); box-shadow: none; }

        .note-area { display: flex; flex-direction: column; gap: 8px; }
        .note-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex: 1; }
        .btn-n { background: #1e293b; border: 1px solid #334155; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: 0.1s; height: 45px; box-shadow: 0 4px 0 var(--shadow-dark); position: relative; top: 0; }
        .btn-n:active { transform: translateY(4px); box-shadow: none; }
        .btn-n.active { background: #C084FC; color: white; border: none; box-shadow: 0 4px 0 var(--shadow-purple); }
        .btn-n.active:active { transform: translateY(4px); box-shadow: none; }

        .tools-row { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; height: 40px; }
        .btn-tool { background: #334155; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 0.85rem; box-shadow: 0 4px 0 var(--shadow-dark); transition: 0.1s; }
        .btn-tool:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-tool.undo-btn { background: #EF4444; box-shadow: 0 4px 0 var(--shadow-red); }
        .btn-tool.undo-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-tool.play-btn { background: #38BDF8; color:#0F172A; box-shadow: 0 4px 0 var(--shadow-blue); }
        .btn-tool.play-btn.playing { background: #F43F5E; color: white; box-shadow: 0 4px 0 var(--shadow-red); animation: pulse 1s infinite; }
        .btn-tool.play-btn:active { transform: translateY(4px); box-shadow: none; }

        .btn-tool.inv-btn { background: #C084FC; color:#0F172A; box-shadow: 0 4px 0 var(--shadow-purple); }
        .btn-tool.inv-btn:active { transform: translateY(4px); box-shadow: none; }

        .acc-text { font-family: 'Times New Roman', serif; font-size: 1.4rem; line-height: 1; }

        /* Tour Guide */
        #tour-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s; }
        #tour-backdrop.active { display: block; opacity: 1; }
        #tour-tooltip { position: fixed; width: 280px; background: #1E293B; color: #F1F5F9; padding: 20px; border-radius: 16px; border: 2px solid #38BDF8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); z-index: 10000; display: none; transition: all 0.3s ease; }
        #tour-tooltip::after { content: ''; position: absolute; border-width: 10px; border-style: solid; border-color: #38BDF8 transparent transparent transparent; bottom: -22px; left: 50%; transform: translateX(-50%); }
        #tour-tooltip.top::after { top: 100%; bottom: auto; border-color: #38BDF8 transparent transparent transparent; }
        #tour-tooltip.bottom::after { bottom: 100%; top: auto; border-color: transparent transparent #38BDF8 transparent; }
        .tour-focus { position: relative; z-index: 9999 !important; box-shadow: 0 0 0 4px #FACC15, 0 0 50px rgba(0,0,0,0.9) !important; background-color: #1E293B !important; border-radius: 8px; transition: box-shadow 0.3s; pointer-events: none; }
        .tour-controls { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn-tour { padding: 8px 16px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: 'Sarabun', sans-serif; transition:0.2s; }
        .btn-next { background: #38BDF8; color: #093649; } .btn-next:hover{ background: #7DD3FC; }
        .btn-skip { background: transparent; color: #94A3B8; } .btn-skip:hover{ color: #E2E8F0; }
        .btn-start-tour { position: fixed; bottom: 300px; right: 20px; top: auto; margin-top: 0; width: 50px; height: 50px; border-radius: 50%; background: #38BDF8; color: #093649; border: 3px solid #1E293B; font-size: 1.6rem; font-weight: bold; cursor: pointer; z-index: 9000; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; animation: tourPulse 2s infinite; }
        @keyframes tourPulse { 0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); transform: scale(1); } 70% { box-shadow: 0 0 0 15px rgba(56, 189, 248, 0); transform: scale(1.05); } 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); transform: scale(1); } }
        @media (max-width: 480px) { .btn-start-tour { right: 10px; width: 45px; height: 45px; font-size: 1.4rem; margin-top:-22.5px; } }
    </style>
</head>
<body>
    <div id="top-bar">
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> <span>‡∏≠‡∏≠‡∏Å</span></a>
        <div class="logo">HARMONIX</div>
        <div class="key-wrapper">
            <select id="key-select" onchange="playSfx('click'); changeKey(this.value)">
                <option value="C">Key: C</option>
                <option value="G">Key: G</option>
                <option value="D">Key: D</option>
                <option value="F">Key: F</option>
                <option value="Bb">Key: Bb</option>
                <option value="Am">Key: Am</option>
                <option value="Em">Key: Em</option>
            </select>
        </div>
    </div>

    <div id="score-area">
        <div id="vexflow-wrapper">
            <div id="vexflow-out"></div>
        </div>
    </div>

    <div id="warning-bar">
        <div class="chord-info">
            <span>Chord: <span id="txt-chord" style="color:white;">-</span></span>
            <span id="ui-cadence" class="cadence-badge hidden"></span>
        </div>
        <div></div>
        <div id="ui-message" class="status-ok"><i class="fa-solid fa-circle-check"></i> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    </div>

    <div id="controls">
        <div class="beat-scroll" id="beat-list"></div>
        
        <div class="grid-main">
            <div class="voice-col">
                <button class="btn-v selected" id="v-s" onclick="setVoice('s')">S</button>
                <button class="btn-v" id="v-a" onclick="setVoice('a')">A</button>
                <button class="btn-v" id="v-t" onclick="setVoice('t')">T</button>
                <button class="btn-v" id="v-b" onclick="setVoice('b')">B</button>
            </div>
            
            <div class="note-area">
                <div class="note-row">
                    <button class="btn-n" onclick="playToneNote('c'); setNote('c')" id="n-c">C</button>
                    <button class="btn-n" onclick="playToneNote('d'); setNote('d')" id="n-d">D</button>
                    <button class="btn-n" onclick="playToneNote('e'); setNote('e')" id="n-e">E</button>
                    <button class="btn-n" onclick="playToneNote('f'); setNote('f')" id="n-f">F</button>
                    <button class="btn-n" onclick="playToneNote('g'); setNote('g')" id="n-g">G</button>
                    <button class="btn-n" onclick="playToneNote('a'); setNote('a')" id="n-a">A</button>
                    <button class="btn-n" onclick="playToneNote('b'); setNote('b')" id="n-b">B</button>
                </div>
                
                <div class="tools-row">
                    <button class="btn-tool acc-text" onclick="playSfx('click'); setAcc('#')" style="color:#FACC15">‚ôØ</button>
                    <button class="btn-tool acc-text" onclick="playSfx('click'); setAcc('n')">‚ôÆ</button>
                    <button class="btn-tool acc-text" onclick="playSfx('click'); setAcc('b')" style="color:#C084FC">‚ô≠</button>
                    <button class="btn-tool" onclick="playSfx('click'); shiftOctave(1)">Oct+</button>
                    <button class="btn-tool" onclick="playSfx('click'); shiftOctave(-1)">Oct-</button>
                    <button class="btn-tool inv-btn" id="btn-inv" onclick="playSfx('click'); autoInvert()">Inv</button>
                    <button class="btn-tool undo-btn" onclick="playSfx('click'); undo()"><i class="fa-solid fa-rotate-left"></i></button>
                    <button class="btn-tool play-btn" id="btn-play" onclick="togglePlay()"><i class="fa-solid fa-play" id="btn-play-icon"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="tour-backdrop"></div>
    <div id="tour-tooltip">
        <h3 id="tour-title" style="margin:0 0 8px 0; color:#38BDF8; font-size:1.2rem;"></h3>
        <p id="tour-desc" style="margin:0; font-size:0.95rem; line-height:1.6; color:#CBD5E1;"></p>
        <div class="tour-controls">
            <button class="btn-tour btn-skip" onclick="playSfx('click'); endTour()">‡∏Ç‡πâ‡∏≤‡∏°</button>
            <button class="btn-tour btn-next" onclick="playSfx('click'); nextStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right"></i></button>
        </div>
    </div>
    <button class="btn-start-tour" onclick="playSfx('click'); startTour()"><i class="fa-solid fa-hand-point-up"></i></button>

<script>
    // --- AUDIO & SCROLL LOGIC ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const clickSfx = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");
    clickSfx.volume = 0.5;
    window.playSfx = (type) => { if(type==='click') { clickSfx.currentTime = 0; clickSfx.play().catch(()=>{}); } };

    const NOTE_FREQS = { 'c': 261.63, 'c#': 277.18, 'db': 277.18, 'd': 293.66, 'd#': 311.13, 'eb': 311.13, 'e': 329.63, 'f': 349.23, 'f#': 369.99, 'gb': 369.99, 'g': 392.00, 'g#': 415.30, 'ab': 415.30, 'a': 440.00, 'a#': 466.16, 'bb': 466.16, 'b': 493.88 };

    window.playToneNote = (noteName) => {
        try { if(audioCtx.state === 'suspended') audioCtx.resume(); const n = scoreData[curM].beats[curB][curV]; let freq = NOTE_FREQS[noteName.toLowerCase()] || 440; freq = freq * Math.pow(2, n.o - 4); playSound(freq); } catch(e) {}
    };

    let isPlayingSequence = false;
    let activeOscillators = [];
    let playbackTimeouts = [];

    window.togglePlay = () => { if (isPlayingSequence) stopPlayback(); else playSequence(); };

    function stopPlayback() {
        isPlayingSequence = false;
        activeOscillators.forEach(osc => { try { osc.stop(); } catch(e){} });
        activeOscillators = [];
        playbackTimeouts.forEach(clearTimeout);
        playbackTimeouts = [];
        document.getElementById('btn-play-icon').className = "fa-solid fa-play";
        document.getElementById('btn-play').classList.remove('playing');
        renderUI();
    }

    function playSequence() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        isPlayingSequence = true;
        document.getElementById('btn-play-icon').className = "fa-solid fa-stop";
        document.getElementById('btn-play').classList.add('playing');
        const tempo = 100; const beatDuration = 60/tempo; let totalBeats = 0;
        scoreData.forEach((measure, mIdx) => {
            measure.beats.forEach((beat, bIdx) => {
                const startTime = audioCtx.currentTime + (totalBeats * beatDuration);
                playBeatAtTime(beat, startTime, beatDuration);
                const uiTimeout = setTimeout(() => { if(!isPlayingSequence) return; curM = mIdx; curB = bIdx; renderUI(); }, totalBeats * beatDuration * 1000);
                playbackTimeouts.push(uiTimeout);
                totalBeats++;
            });
        });
        playbackTimeouts.push(setTimeout(() => { stopPlayback(); }, totalBeats * beatDuration * 1000));
    }

    // Auto Invert
    window.autoInvert = () => {
        saveState();
        const beat = scoreData[curM].beats[curB];
        const map = {c:0, d:2, e:4, f:5, g:7, a:9, b:11};
        const getVal = (n) => (n.o * 12) + map[n.n] + (n.acc==='#'?1:n.acc==='b'?-1:0);
        let notes = [{...beat.b}, {...beat.t}, {...beat.a}, {...beat.s}];
        notes.sort((a,b) => getVal(a) - getVal(b));
        notes[0].o += 1; // Move bass up
        notes.sort((a,b) => getVal(a) - getVal(b));
        if (getVal(notes[0]) > (4*12)) notes.forEach(n => n.o -= 1); // Reset if too high
        beat.b = notes[0]; beat.t = notes[1]; beat.a = notes[2]; beat.s = notes[3];
        renderScore(); renderUI(); playChord();
    };

    window.playChord = () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const beat = scoreData[curM].beats[curB]; playBeatAtTime(beat, audioCtx.currentTime, 0.8); };

    function playBeatAtTime(beat, time, duration) {
        ['s', 'a', 't', 'b'].forEach(v => {
            const n = beat[v];
            if(n) {
                let freq = NOTE_FREQS[n.n.toLowerCase()] || 440;
                freq = freq * Math.pow(2, n.o - 4);
                if(n.acc === '#') freq *= 1.05946; if(n.acc === 'b') freq /= 1.05946;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(time); gain.gain.setValueAtTime(0.3, time); gain.gain.exponentialRampToValueAtTime(0.001, time + duration - 0.05); osc.stop(time + duration);
                activeOscillators.push(osc); osc.onended = () => { const idx = activeOscillators.indexOf(osc); if(idx > -1) activeOscillators.splice(idx, 1); };
            }
        });
    }

    function playSound(freq, vol=0.5) {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.8); osc.stop(audioCtx.currentTime + 0.8);
    }

    // --- MAIN LOGIC ---
    let scoreData = Array(4).fill(null).map(() => ({ key: 'C', beats: Array(4).fill(null).map(() => ({ s: { n:'c', o:5, acc:'' }, a: { n:'g', o:4, acc:'' }, t: { n:'e', o:4, acc:'' }, b: { n:'c', o:3, acc:'' } })) }));
    let curM = 0, curB = 0, curV = 's', errors = {}; let historyStack = []; const VF = Vex.Flow;
    const KEY_DATA = { 'C': { root: 0, sharps: [] }, 'G': { root: 7, sharps: ['f'] }, 'D': { root: 2, sharps: ['f','c'] }, 'F': { root: 5, flats: ['b'] }, 'Bb': { root: 10, flats: ['b','e'] }, 'Am': { root: 9, sharps: [] }, 'Em': { root: 4, sharps: ['f'] } };
    
    // ** DRAG SCROLL FIX **
    let isDown = false, startX, scrollLeft, isDragging = false;
    window.onload = () => { 
        renderUI(); renderScore(); 
        const slider = document.getElementById('beat-list');
        // Mouse Down
        slider.addEventListener('mousedown', (e) => { 
            isDown = true; 
            slider.classList.add('active'); // CSS cursor grabbing
            startX = e.pageX - slider.offsetLeft; 
            scrollLeft = slider.scrollLeft; 
            isDragging = false; 
        });
        // Mouse Leave
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
        // Mouse Up
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => isDragging = false, 50); });
        // Mouse Move
        slider.addEventListener('mousemove', (e) => { 
            if(!isDown) return; 
            e.preventDefault(); 
            const x = e.pageX - slider.offsetLeft; 
            const walk = (x - startX) * 2; 
            slider.scrollLeft = scrollLeft - walk; 
            if(Math.abs(walk) > 5) isDragging = true; 
        });
    };

    function saveState() { if(historyStack.length > 20) historyStack.shift(); historyStack.push(JSON.stringify(scoreData)); }
    window.undo = () => { playSfx('click'); if(historyStack.length){ scoreData = JSON.parse(historyStack.pop()); renderScore(); renderUI(); } };
    window.changeKey = (k) => { saveState(); scoreData[curM].key = k; renderScore(); };
    window.setVoice = (v) => { playSfx('click'); curV = v; renderUI(); renderScore(); };
    window.setNote = (n) => { saveState(); scoreData[curM].beats[curB][curV].n = n; scoreData[curM].beats[curB][curV].acc = ''; renderScore(); renderUI(); };
    window.setAcc = (acc) => { saveState(); let c = scoreData[curM].beats[curB][curV].acc; scoreData[curM].beats[curB][curV].acc = (c===acc)?'':acc; renderScore(); };
    window.shiftOctave = (dir) => { saveState(); let v = scoreData[curM].beats[curB][curV].o + dir; if(v>=2&&v<=6) scoreData[curM].beats[curB][curV].o = v; renderScore(); };
    
    function renderScore() {
        const div = document.getElementById("vexflow-out"); div.innerHTML = "";
        const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
        const mWidth = 380; const totalWidth = (scoreData.length * mWidth) + 50;
        renderer.resize(totalWidth, 300);
        const ctx = renderer.getContext(); ctx.scale(1, 1); ctx.setFillStyle("black"); ctx.setStrokeStyle("black");
        let xPos = 10; errors = {}; const allAnalysis = [];
        scoreData.forEach(m => m.beats.forEach(b => allAnalysis.push(analyzeHarmony(b, m.key))));
        scoreData.forEach((measure, mIdx) => {
            const sT = new VF.Stave(xPos, 20, mWidth); const sB = new VF.Stave(xPos, 130, mWidth);
            if(mIdx === 0) { sT.addClef("treble").addTimeSignature("4/4").addKeySignature(measure.key); sB.addClef("bass").addTimeSignature("4/4").addKeySignature(measure.key); } else if (scoreData[mIdx-1].key !== measure.key) { sT.addKeySignature(measure.key); sB.addKeySignature(measure.key); }
            sT.setContext(ctx).draw(); sB.setContext(ctx).draw();
            const createNotes = (part, clef, stem) => measure.beats.map((b, bIdx) => {
                const sn = new VF.StaveNote({ keys: [`${b[part].n}/${b[part].o}`], duration: "q", clef: clef, stem_direction: stem });
                if(b[part].acc) sn.addModifier(new VF.Accidental(b[part].acc));
                if(mIdx === curM && bIdx === curB) { if(part === curV) sn.setStyle({ fillStyle: "#0533EA", strokeStyle: "#0533EA" }); else sn.setStyle({ fillStyle: "#C74207", strokeStyle: "#C74207" }); } else { sn.setStyle({ fillStyle: "black", strokeStyle: "black" }); }
                return sn;
            });
            const vS = new VF.Voice({num_beats:4, beat_value:4}).addTickables(createNotes('s','treble',1));
            const vA = new VF.Voice({num_beats:4, beat_value:4}).addTickables(createNotes('a','treble',-1));
            const vT = new VF.Voice({num_beats:4, beat_value:4}).addTickables(createNotes('t','bass',1));
            const vB = new VF.Voice({num_beats:4, beat_value:4}).addTickables(createNotes('b','bass',-1));
            new VF.Formatter().joinVoices([vS, vA]).joinVoices([vT, vB]).format([vS, vA, vT, vB], mWidth - 50);
            vS.draw(ctx, sT); vA.draw(ctx, sT); vT.draw(ctx, sB); vB.draw(ctx, sB);
            measure.beats.forEach((_, bIdx) => {
                const res = allAnalysis[mIdx * 4 + bIdx];
                const noteX = vB.getTickables()[bIdx].getAbsoluteX();
                ctx.setFont("Noto Serif", 14, "bold").setFillStyle("black");
                const romanWidth = ctx.measureText(res.roman).width; ctx.fillText(res.roman, noteX, 250); 
                if(res.figures && res.figures.length > 0) {
                    ctx.setFont("Sarabun", 11, "bold"); let startY = 245; if(res.figures.length === 2) startY = 240; if(res.figures.length === 3) startY = 235; const lineHeight = 14; const figX = noteX + romanWidth;
                    res.figures.forEach((fig, i) => { let txt = fig.val + fig.acc.replace('n','‚ôÆ').replace('#','‚ôØ').replace('b','‚ô≠'); ctx.fillText(txt, figX, startY + (i * lineHeight)); });
                }
            });
            checkErrorsInMeasure(mIdx); xPos += mWidth;
        });
        const res = allAnalysis[curM*4 + curB]; document.getElementById('txt-chord').innerText = `${res.name} (${res.roman})`; updateCadenceUI(allAnalysis);
        const activeErr = errors[curM*4 + curB]; const msgDiv = document.getElementById('ui-message');
        if(activeErr) { msgDiv.className = 'status-err'; msgDiv.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${activeErr}`; } else { msgDiv.className = 'status-ok'; msgDiv.innerHTML = `<i class="fa-solid fa-circle-check"></i> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`; }
    }
    
    function updateCadenceUI(all) { const cPre = all[14]; const cFin = all[15]; const uiCad = document.getElementById('ui-cadence'); let cadText = ""; if (cFin && cPre) { if (cFin.roman.toLowerCase() === "i") { if (cPre.roman.toLowerCase() === "iv") cadText = "PC"; else if (cPre.roman.toLowerCase().startsWith("v")) cadText = (cFin.isRootPos && cPre.isRootPos) ? "PAC" : "IAC"; } else if (cFin.roman.toLowerCase().startsWith("v")) cadText = "HC"; else if (cPre.roman.toLowerCase().startsWith("v") && cFin.roman.toLowerCase() === "vi") cadText = "DC"; } if(cadText) { uiCad.innerText = cadText; uiCad.classList.remove('hidden'); uiCad.style.display = 'inline-block'; } else { uiCad.style.display = 'none'; } }
    function checkErrorsInMeasure(mIdx) { for(let b=0; b<4; b++) { const idx = mIdx*4 + b; const beat = scoreData[mIdx].beats[b]; const getM = (n) => { const map={c:0,d:2,e:4,f:5,g:7,a:9,b:11}; return (n.o+1)*12 + map[n.n] + (n.acc=='#'?1:n.acc=='b'?-1:0); }; const s=getM(beat.s), a=getM(beat.a), t=getM(beat.t), bs=getM(beat.b); if(s<a || a<t || t<bs) errors[idx] = "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏±‡∏ô"; else if(s-a > 12 || a-t > 12) errors[idx] = "‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏π‡πà 8"; if(idx > 0) { const pm = Math.floor((idx-1)/4), pb = (idx-1)%4; const prev = scoreData[pm].beats[pb]; const ps=getM(prev.s), pa=getM(prev.a), pt=getM(prev.t), pbs=getM(prev.b); const checkPar = (v1,v2, pv1,pv2, name) => { const int1 = (v1-v2)%12; const int2 = (pv1-pv2)%12; if(v1!==pv1 && ((int1===7 && int2===7) || (int1===0 && int2===0))) errors[idx] = `‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô 5/8 (${name})`; }; checkPar(s,bs,ps,pbs,"S-B"); checkPar(s,a,ps,pa,"S-A"); checkPar(a,t,pa,pt,"A-T"); checkPar(t,bs,pt,pbs,"T-B"); } } }
    function analyzeHarmony(beat, keyName) { const keyInfo = KEY_DATA[keyName] || KEY_DATA['C']; const map = {c:0, d:2, e:4, f:5, g:7, a:9, b:11}; const getPC = (n) => { let val = map[n.n]; if(n.acc === '#') val++; if(n.acc === 'b') val--; return (val + 12) % 12; }; const pcs = [getPC(beat.s), getPC(beat.a), getPC(beat.t), getPC(beat.b)]; const uniq = [...new Set(pcs)].sort((a,b)=>a-b); let detectedRoot = -1; let quality = "maj"; for (let r of uniq) { const intervals = uniq.map(u => (u - r + 12) % 12).sort((a,b)=>a-b); if (intervals.includes(0) && intervals.includes(4) && intervals.includes(7)) { detectedRoot = r; quality="maj"; break; } if (intervals.includes(0) && intervals.includes(3) && intervals.includes(7)) { detectedRoot = r; quality="min"; break; } if (intervals.includes(0) && intervals.includes(3) && intervals.includes(6)) { detectedRoot = r; quality="dim"; break; } } if (detectedRoot === -1) detectedRoot = pcs[3]; const degree = (detectedRoot - keyInfo.root + 12) % 12; const romans = { 0: "I", 2: "ii", 4: "iii", 5: "IV", 7: "V", 9: "vi", 11: "vii¬∞" }; let roman = romans[degree] || "?"; if (quality === "min" || quality === "dim") roman = roman.toLowerCase(); if (quality === "maj") roman = roman.toUpperCase(); if (quality === "dim" && !roman.includes("¬∞")) roman += "¬∞"; const bassVal = map[beat.b.n]; const diatonicMap = {c:0, d:1, e:2, f:3, g:4, a:5, b:6}; let figures = []; [beat.t, beat.a, beat.s].forEach(v => { const vDia = diatonicMap[v.n]; const bDia = diatonicMap[beat.b.n]; let interval = (vDia - bDia + 7) % 7 + 1; let acc = v.acc || ""; let show = false; if (acc) show = true; if (interval === 4 || interval === 2 || interval === 6 || interval === 7 || interval === 9) show = true; if (show && interval !== 1 && interval !== 8) { figures.push({val:interval, acc:acc}); } }); figures.sort((a,b) => b.val - a.val); figures = figures.filter((f, index, self) => index === self.findIndex((t) => (t.val === f.val && t.acc === f.acc)) ); let figStrs = figures.map(f => f.val); let isRootPos = true; if (figStrs.includes(6) || figStrs.includes(4)) isRootPos = false; const noteNames = ["C","Db","D","Eb","E","F","F#","G","Ab","A","Bb","B"]; let cName = noteNames[detectedRoot] + (quality==="min"?"m":quality==="dim"?"dim":""); return { name: cName, roman: roman, figures: figures, isRootPos: isRootPos }; }
    
    function renderUI() { 
        const list = document.getElementById('beat-list'); list.innerHTML = ''; 
        for(let i=0; i<16; i++) { 
            const m = Math.floor(i/4), b = i%4; 
            const div = document.createElement('div'); 
            div.className = `beat-box ${m===curM && b===curB ? 'active' : ''} ${errors[i] ? 'error' : ''}`; 
            div.innerHTML = `<span>Bar${m+1}</span>${b+1}`; 
            // Fix: ‡∏ñ‡πâ‡∏≤‡∏•‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà (isDragging=true) ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            div.onclick = () => { 
                if(isDragging) return; 
                playSfx('click'); curM = m; curB = b; renderScore(); renderUI(); 
            }; 
            list.appendChild(div); 
        } 
        document.querySelectorAll('.btn-v').forEach(b => b.classList.toggle('selected', b.id === `v-${curV}`)); 
        document.querySelectorAll('.btn-n').forEach(b => b.classList.toggle('active', b.id === `n-${scoreData[curM].beats[curB][curV].n}`)); 
    }

    // --- Tour Logic ---
    const steps = [
        { el: '#key-select', title: '1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏û‡∏•‡∏á', desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ! ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå (‡πÄ‡∏ä‡πà‡∏ô C, G, Am) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Key Signature ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á' },
        { el: '#beat-list', title: '2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á', desc: '‡πÅ‡∏ñ‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á (Bar) ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏•‡∏≤‡∏Å‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ' },
        { el: '.voice-col', title: '3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á', desc: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô S(‡∏™‡∏π‡∏á‡∏´‡∏ç‡∏¥‡∏á) A(‡∏ï‡πà‡∏≥‡∏´‡∏ç‡∏¥‡∏á) T(‡∏™‡∏π‡∏á‡∏ä‡∏≤‡∏¢) B(‡∏ï‡πà‡∏≥‡∏ä‡∏≤‡∏¢)' },
        { el: '.note-area', title: '4. ‡πÉ‡∏™‡πà‡πÇ‡∏ô‡πâ‡∏ï‡∏î‡∏ô‡∏ï‡∏£‡∏µ', desc: '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° C-B ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î #/b ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Octave' },
        { el: '#warning-bar', title: '5. ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', desc: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏î‡∏á ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏é Harmony' },
        { el: '#btn-inv', title: '6. ‡∏û‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', desc: '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Inversion ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏î (Root -> 1st -> 2nd) ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!' },
        { el: '#btn-play', title: '7. ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á', desc: '‡∏Å‡∏î Play ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Stop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î' },
        { el: '.undo-btn', title: '8. ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö', desc: '‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏ú‡∏¥‡∏î ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' }
    ];
    let curStep = 0; const tooltip = document.getElementById('tour-tooltip'); const backdrop = document.getElementById('tour-backdrop');
    function startTour() { curStep = 0; backdrop.classList.add('active'); tooltip.style.display = 'block'; showStep(); }
    function endTour() { backdrop.classList.remove('active'); tooltip.style.display = 'none'; document.querySelectorAll('.tour-focus').forEach(el => el.classList.remove('tour-focus')); document.querySelector('.btn-start-tour').scrollIntoView({behavior: "smooth", block: "center"}); }
    function nextStep() { const prevEl = document.querySelector(steps[curStep].el); if(prevEl) prevEl.classList.remove('tour-focus'); curStep++; if (curStep >= steps.length) { endTour(); } else { showStep(); } }
    function showStep() { const step = steps[curStep]; const target = document.querySelector(step.el); if (!target) { nextStep(); return; } document.getElementById('tour-title').innerText = step.title; document.getElementById('tour-desc').innerText = step.desc; target.classList.add('tour-focus'); target.scrollIntoView({behavior: "smooth", block: "center"}); const rect = target.getBoundingClientRect(); const tipRect = tooltip.getBoundingClientRect(); let top = rect.top - tipRect.height - 20; let left = rect.left + (rect.width/2) - (tipRect.width/2); if(top < 20) { top = rect.bottom + 20; tooltip.className = "bottom"; } else { tooltip.className = "top"; } if(left < 10) left = 10; if(left + tipRect.width > window.innerWidth) left = window.innerWidth - tipRect.width - 10; tooltip.style.top = top + 'px'; tooltip.style.left = left + 'px'; document.querySelector('.btn-next').innerHTML = (curStep === steps.length - 1) ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô <i class="fa-solid fa-check"></i>' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right"></i>'; }
</script>
<div id="invite-toast" style="position:fixed; top:20px; right:20px; background:#1E293B; color:white; padding:15px; border-radius:12px; border-left:4px solid #FACC15; display:none; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.5s;">
    <div style="font-weight:bold; margin-bottom:5px;">‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°! üéÆ</div>
    <div id="inv-msg" style="font-size:0.9rem; color:#94A3B8;">User ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô</div>
    <div style="margin-top:10px; display:flex; gap:10px;">
        <button onclick="acceptInvite()" style="flex:1; background:#38BDF8; border:none; border-radius:6px; padding:6px; color:#0F172A; font-weight:bold; cursor:pointer;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
        <button onclick="closeInvite()" style="flex:1; background:transparent; border:1px solid #475569; border-radius:6px; padding:6px; color:#94A3B8; cursor:pointer;">‡πÑ‡∏°‡πà‡∏™‡∏ô</button>
    </div>
</div>

<style> @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } } </style>

<script type="module">
    import { getFirestore, collection, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const db = getFirestore();
    const auth = getAuth();
    let currentInvite = null;
    let autoCloseTimer = null;

    onAuthStateChanged(auth, (user) => {
        if(user) {
            onSnapshot(collection(db, `users/${user.uid}/notifications`), (snap) => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        if(data.type === 'invite') {
                            currentInvite = { id: change.doc.id, ...data };
                            showInvite(data);
                        }
                    }
                });
            });
        }
    });

    function showInvite(data) {
        const toast = document.getElementById('invite-toast');
        document.getElementById('inv-msg').innerText = `${data.fromName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°!`;
        toast.style.display = 'block';
        
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
        try { new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3").play().catch(()=>{}); } catch(e){}

        // **‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á**
        if(autoCloseTimer) clearTimeout(autoCloseTimer);
        autoCloseTimer = setTimeout(() => {
            closeInvite();
        }, 5000); 
    }

    window.closeInvite = () => {
        const toast = document.getElementById('invite-toast');
        toast.style.display = 'none';
        // ‡∏•‡∏ö Invite ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DB ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏≤‡∏á
        if(currentInvite && auth.currentUser) {
             deleteDoc(doc(db, `users/${auth.currentUser.uid}/notifications/${currentInvite.id}`)).catch(()=>{});
        }
    };

    window.acceptInvite = async () => {
        if(currentInvite) {
            // ‡∏•‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            await deleteDoc(doc(db, `users/${auth.currentUser.uid}/notifications/${currentInvite.id}`));
            // **‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ auto-join**
            window.location.href = `multi.html?mode=join&room=${currentInvite.roomId}`; 
        }
    };
</script>

</body>
</html>